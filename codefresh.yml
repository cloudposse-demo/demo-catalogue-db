# Build a service with environment variables
version: '1.0'

steps:
  semver:
    title: Export semversion
    image: cloudposse/build-harness:feature-helm-chart-ops
    working_directory: ${{build-image}}
    commands:
      - make git:show
      - make semver:show
      - make semver:export > ${{CF_VOLUME_PATH}}/env_vars_to_expor
    environment:
      - GIT_BRANCH=${{CF_BRANCH}}

  build-image:
    type: build
    description: Build catalogue db
    image-name: cloudpossedemo/catalogue-db
    dockerfile: Dockerfile

  build-chart:
    title: Build Charts
    image: cloudposse/build-harness:feature-helm-chart-ops
    working_directory: ${{build-image}}
    commands:
      - make helm:repo:add-remote
      - make helm:chart:build-all
      - make helm:chart:publish

  push-image:
    type: push
    candidate: ${{build-image}}
    tags: [ ${{TAG_LIST}} ]

  push-image-latest:
    type: push
    candidate: ${{build-image}}
    tag: latest
    when:
      condition:
        all:
          executeForMasterBranch: "'${{CF_BRANCH}}' == 'master'"